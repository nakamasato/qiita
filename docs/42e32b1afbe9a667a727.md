---
title: Argo CD ã‚’ä½¿ã£ã¦è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦ã™ (ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒå¯)
tags: cd kubernetes Kind ArgoCD
author: nakamasato
slide: false
---
# ã‚„ã‚‹ã“ã¨

1. k8sä¸Šã«Argo CDã‚’Deploy
2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Argo CDã«ç™»éŒ²ã—ã¦å‹•ã™
3. ç™»éŒ²ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰RepoãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨k8sä¸Šã§å‹•ã„ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ›´æ–°ã•ã‚Œã‚‹

# k8sã‚¯ãƒ©ã‚¹ã‚¿ã®æº–å‚™

ã™ã§ã«k8sã‚¯ãƒ©ã‚¹ã‚¿ãŒã‚ã‚‹äººã¯ã€ã‚¹ã‚­ãƒƒãƒ—ã€‚

ä»Šå›ã¯ã€kind (https://github.com/kubernetes-sigs/kind) ã‚’ä½¿ã†ã€‚ (ã‚‚ã¡ã‚ã‚“minikubeã§ã‚‚ã‚ˆã„)

goãŒã‚ã‚Œã°ã²ã¨ã‚³ãƒãƒ³ãƒ‰ã§ç«‹ã¤ã€‚

```
GO111MODULE="on" go get sigs.k8s.io/kind@v0.5.1 && kind create cluster
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.15.3) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦
 âœ“ Creating kubeadm config ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
Cluster creation complete. You can now use the cluster with:

export KUBECONFIG="$(kind get kubeconfig-path --name="kind")"
kubectl cluster-info
```

`kind: command not found` ã¨è¨€ã‚ã‚ŒãŸã‚‰pathãŒé€šã£ã¦ãªã„ã®ã§ã€kindã®ãŠã„ã¦ã‚ã‚‹ãƒ‘ã‚¹ã‚’é€šã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€kindã¨ã„ã†åå‰ã®clusterãŒã§ãã‚‹

```
kind get clusters
kind
```

æ”¯æŒé€šã‚Šä»¥ä¸‹ã‚’å®Ÿè¡Œã—, kube contextã‚’kindã§ç«‹ã¦ãŸclusterã«ã™ã‚‹

```
export KUBECONFIG="$(kind get kubeconfig-path --name="kind")"
kubectl cluster-info
```

```
kubectl cluster-info
Kubernetes master is running at https://127.0.0.1:59925
KubeDNS is running at https://127.0.0.1:59925/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'
```

nodesãªã©ã‚’é©å½“ã«ãƒã‚§ãƒƒã‚¯

```
kubectl get nodes
NAME                 STATUS   ROLES    AGE     VERSION
kind-control-plane   Ready    master   3m57s   v1.15.3
```



# Argo CD åŸºæœ¬

https://argoproj.github.io/argo-cd/getting_started/
ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚ã°å¤§ä½“ã‚ã‹ã‚‹

åŸºæœ¬ã¯ã€ä»¥ä¸‹ã®é€šã‚Š

1. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« 

    ```
    kubectl create namespace argocd
    kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
    ```
2. cliå…¥ã‚Œã‚‹

    ```
    brew tap argoproj/tap
    brew install argoproj/tap/argocd
    ```
3. cliã§loginã™ã‚‹ â†’ passwordå¤‰æ›´

    ```:port-forward
kubectl port-forward svc/argocd-server -n argocd 8080:443
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
    ```

    ```:login
argocd login localhost:8080
WARNING: server certificate had error: x509: certificate signed by unknown authority. Proceed insecurely (y/n)? y
Username: admin
Password:
'admin' logged in successfully
Context 'localhost:8080' updated
    ```

    ```:update-password
argocd account update-password
*** Enter current password:
*** Enter new password:
*** Confirm new password:
Password updated
Context 'localhost:8080' updated    
    ```
4. GUI (https://localhost:8080/login) ã§ãƒ­ã‚°ã‚¤ãƒ³

    ![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/989f73f6-8b2b-8f77-2aaa-247ddcc4b33f.png)

    ![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/62b9617b-7376-cf96-dee7-507256c58e99.png)

5. clusterã®ç™»éŒ² (ä»Šå›ã¯ã€ArgoCDãŒDeployã•ã‚Œã¦ã‚‹Clusterã‚’ä½¿ã†ã®ã§ã‚¹ã‚­ãƒƒãƒ—)



    ```
    argocd cluster add <kube context>
    ```


6. applicationã‚’ä½œæˆ


    deployå…ˆã®namespace `test-ns`ã‚’ä½œã‚‹ (ç·´ç¿’ãƒ¬ãƒ: https://github.com/nakamasato/k8s-deploy-test)

    ```
    kubectl create namespace test-ns
    ```

    ã‚¢ãƒ—ãƒªã®ä½œæˆ

    ```
    argocd app create guestbook \
    --repo https://github.com/nakamasato/k8s-deploy-test.git \
    --path apps/guestbook \
    --dest-server https://kubernetes.default.svc \
    --dest-namespace test-ns \
    --auto-prune \
    --sync-policy automated
    ```

    Dashboardä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã®ãŒç¢ºèªã§ãã‚‹

    ![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/bf8aaaa9-f2c2-2acd-17dc-3cc64ebf9881.png)


    deployã—ãŸä¸­èº«ã¯ã€ä»¥ä¸‹ã®æ§‹æˆã®prodéƒ¨åˆ† `test-ns/guestbook/overlays/prod` (kustomizeã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã¡ã‚‡ã£ã¨è¤‡é›‘) 

    ```
    tree
    .
    â”œâ”€â”€ README.md
    â”œâ”€â”€ guestbook-ui-deployment.yaml
    â””â”€â”€ guestbook-ui-svc.yaml

    0 directories, 3 files
    ```


7. gitã‚’æ›´æ–° â†’ Argo CDãŒè‡ªå‹•ã§æ›´æ–°

ä¾‹ãˆã°ã€`guestbook-ui-deployment.yaml`ã®`replicas`ã‚’5ãªã©ã«å¤‰æ›´ã—ã¦Pushã™ã‚‹ã¨ã€Argo CDã¯Defaultã§3åˆ†ã”ã¨(?)ã«è‡ªå‹•Syncã—ã¦ã‚¢ãƒ—ãƒ©ã‚¤ã—ã¦ãã‚Œã‚‹ (`--sync-policy automated`ã®å ´åˆ)



# ãã®ä»–

- kustomize, helmãªã©ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³
- repoã®åˆ‡ã‚Šæ–¹
- sealed secretãªã©ã®ç§˜åŒ¿æƒ…å ±ç®¡ç†
- canary, blue greenãªã©deployment strategy

ã“ã‚Œã‚‰ã¯åˆ¥ã§



