---
title: GCP Error ReportingをSlack連携する
tags: GoogleCloud Slack SlackApp
author: nakamasato
slide: false
---
# やりたいこと

GCP Error Reportingが便利なのでSlackに連携する

# Slack App作成

https://api.slack.com/apps/ からSlack Appを作成

`OAuth & Permissions` からScopeは以下のように設定

![Screenshot 2024-12-02 at 9.21.22.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/7d0d5d61-62ef-975a-3960-0d0f5c4b0e2f.png)

`Install App` からインストールする

`Bot User OAuth Token` が取得できる。(例. `xoxb-11111111-xxxxxxxx`)

# GCP Secret Managerの設定

上で取得したBot User OAuth TokenをSecret Managerに設定する

```hcl
resource "google_secret_manager_secret" "slack_bot_token_gcp" {
  secret_id = "slack-bot-token-gcp"
  replication {
    auto {}
  }
}
```

secret manager versionに値を追加 (Console 上 or gcloud)

```
echo -n "xoxb-xxxxxxx" | gcloud secrets versions add slack-bot-token-gcp --data-file=- --project <project>
```

notification channelの設定

```hcl
data "google_secret_manager_secret_version" "slack_bot_token_gcp" {
  secret = "slack-bot-token-gcp"
}

resource "google_monitoring_notification_channel" "slack_proj_internal_system" {
  display_name = "slack-proj-internal-system"
  type         = "slack"
  labels = {
    "channel_name" = "#proj-internal-system" # you can set your own slack channel name
  }

  sensitive_labels {
    auth_token = data.google_secret_manager_secret_version.slack_bot_token_gcp.secret_data
  }
}
```

# GCPのError Reporting を連携

terraform でのError Reportingとの連携はサポートされてないようなので、手動で設定。

https://github.com/hashicorp/terraform-provider-google/issues/12068



![Screenshot 2024-12-02 at 9.47.44.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/76ea90d4-427c-de58-d99c-3e1b1ec181d7.png)

# Slack通知

![Screenshot 2024-12-03 at 10.31.23.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/126f9d47-49ab-8250-26e8-d5f046af0049.png)


通知が来るようになる!

# Ref

- https://github.com/hashicorp/terraform-provider-google/issues/12068
- https://cloud.google.com/blog/products/devops-sre/use-slack-and-webhooks-for-notifications
- https://github.com/hashicorp/terraform-provider-google/issues/14256
- https://registry.terraform.io/providers/hashicorp/google/latest/docs/data-sources/secret_manager_secret_version

