---
title: GitHub ActionsでPRマージ後にキャッシュをクリーンアップする方法
tags: GitHubActions
author: nakamasato
slide: false
---
## 背景

GitHub ActionsではPull Request（PR）でワークフローが実行されると、キャッシュは`refs/pull/.../merge`というマージ参照に対して作成されます。このキャッシュは同じPRの再実行でしか利用できず、ベースブランチや他のPRからはアクセスできません。

> When a cache is created by a workflow run triggered on a pull request, the cache is created for the merge ref (refs/pull/.../merge). Because of this, the cache will have a limited scope and can only be restored by re-runs of the pull request. It cannot be restored by the base branch or other pull requests targeting that base branch.

Ref: https://docs.github.com/en/actions/reference/workflows-and-actions/dependency-caching

## 問題

PRがマージまたはクローズされた後も、これらのキャッシュは残り続けます。

GitHubは各リポジトリに[10GBのキャッシュストレージ制限](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#usage-limits-and-eviction-policy)を設けており、この容量を超えると最も古いキャッシュから自動的に削除されます。PRが頻繁に作成される開発環境では、使用されなくなったPRのキャッシュが容量を占有し続けることで、mainブランチやdevelopブランチなど、継続的に使用される重要なブランチのキャッシュが押し出されてしまいます。これにより、本番デプロイやCI/CDの実行速度が低下する可能性があります。

## 解決策

### 方法1: GitHub Actionを使用した自動削除

PRがクローズされた際に自動的にキャッシュをクリーンアップするワークフローを設定します。

```yaml
name: cleanup-cache
on:
  pull_request:
    types:
      - closed
jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write      # キャッシュの削除権限
      contents: read      # リポジトリの読み取り権限
      pull-requests: read # PRの読み取り権限
    steps:
      - name: Clean cache for the branch name
        uses: opengrabeso/clean-cache@v1.1.0
```

このワークフローの特徴：
- PRがクローズ（マージまたは単純なクローズ）されたときに自動実行
- 該当するブランチに関連するキャッシュを削除
- 必要最小限の権限で動作

### 方法2: GitHub Actions内でGitHub CLIを使用した自動削除

PRクローズ時にGitHub CLIを使用してキャッシュを自動削除するワークフロー：

```yaml
name: cleanup-gha-cache
on:
  pull_request:
    types:
      - closed
  workflow_call:
jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cleanup PR caches
        run: |
          REPO=${{ github.repository }}
          PR_REF="refs/pull/${{ github.event.pull_request.number }}/merge"
          
          echo "Fetching caches for PR #${{ github.event.pull_request.number }}"
          
          # キャッシュリストを取得し、各キャッシュIDを削除
          gh cache list \
            --repo "$REPO" \
            --ref "$PR_REF" \
            --limit 100 \
            --json id \
            --jq '.[].id' | \
          while IFS= read -r cache_id; do
            if [ -n "$cache_id" ]; then
              echo "Deleting cache ID: $cache_id"
              gh cache delete "$cache_id" --repo "$REPO"
            fi
          done
          
          echo "Cache cleanup completed for PR #${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

このスクリプトは`gh cache list --ref "refs/pull/番号/merge"`でPRに関連するキャッシュを取得し、`gh cache delete <cache-id>`で各キャッシュを削除する仕組みです。

詳細: https://cli.github.com/manual/gh_cache_delete

## まとめ

PRベースの開発フローでは、キャッシュの自動クリーンアップを設定することで：
- ストレージの効率的な利用
- キャッシュヒット率の向上
- CI/CDパフォーマンスの維持

が実現できます。

## 参考リンク

- [GitHub Actions のキャッシュについて](https://docs.github.com/ja/actions/using-workflows/caching-dependencies-to-speed-up-workflows)
- [opengrabeso/clean-cache](https://github.com/opengrabeso/clean-cache)
- [GitHub CLI cache コマンド](https://cli.github.com/manual/gh_cache)
- [GitHub Actions Cache API](https://docs.github.com/en/rest/actions/cache)
- https://github.com/OpenGrabeso/clean-cache

