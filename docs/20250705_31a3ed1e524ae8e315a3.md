---
title: [Terraform]「Cannot import non-existent remote object」エラーでGitHubリポジトリをモジュール内でimportできない問題の解決方法
tags: Terraform GitHub
author: nakamasato
slide: false
---
## はじめに

TerraformでGitHubリポジトリを管理する際、既存のリポジトリをTerraformの管理下に取り込むためにimport機能を使用することがあります。しかし、モジュール内のリソースをimportしようとすると、予期しないエラーに遭遇することがあります。

この記事では、私が実際に遭遇した問題とその解決方法について解説します。

## 遭遇した問題

### 状況

以下のような構成でGitHubリポジトリ管理用のモジュールを作成していました。

```
.
├── main.tf
├── github/
│   └── modules/
│       └── standard-repository/
│           ├── main.tf
│           ├── variables.tf
│           └── outputs.tf
```

### エラー内容

既存のGitHubリポジトリ「samplerepo」をモジュール内のリソースにimportしようとしたところ、以下のエラーが発生しました。

```bash
Planning failed. Terraform encountered an error while generating this plan.

╷
│ Error: Cannot import non-existent remote object
│ 
│ While attempting to import an existing object to
│ "module.samplerepo.github_repository.repo", the provider detected
│ that no object exists with the given id. Only pre-existing objects can
│ be imported; check that the id is correct and that is associated
│ with the provider's configured region or endpoint, or use "terraform
│ apply" to create a new remote object for this resource.
```

### import設定

```hcl
# main.tf
import {
  to = module.samplerepo.github_repository.repo
  id = "samplerepo"
}

module "samplerepo" {
  source = "./github/modules/standard-repository"
  
  repository_name        = "samplerepo"
  repository_description = "Sample repository"
  visibility            = "private"
}
```

### プロバイダー設定

```hcl
# main.tf
provider "github" {
  owner = var.github_owner
}
```

## 生github_repositoryリソースではimportできる

興味深いことに、モジュールを使わずに直接`github_repository`リソースを定義した場合は、正常にimportできました。

```hcl
# これは成功する
import {
  to = github_repository.samplerepo_temp
  id = "samplerepo"
}

resource "github_repository" "samplerepo_temp" {
  name        = "samplerepo"
  description = "Sample repository"
  visibility  = "private"
}
```

このことから、問題はモジュールを使用することに関連していることがわかります。つまり、ルートモジュールで定義されたプロバイダー設定が、何らかの理由でモジュール内のリソースに正しく伝達されていない可能性があります。

## 原因の調査

### GitHub Provider側の制限

調査を進めた結果、GitHub Provider の Issue で同様の問題が報告されていることがわかりました。

[Cannot import github_repository into module #2262](https://github.com/integrations/terraform-provider-github/issues/2262)

### 根本原因

問題の根本原因は、**モジュール内でGitHub Providerのowner設定が継承されない**ことでした。

- ルートモジュールでプロバイダーを設定
- モジュール内のリソースがそのプロバイダー設定を正しく参照できない
- 結果として、importしようとするリポジトリを見つけることができない

## 解決方法

### モジュール内でプロバイダーを明示的に設定

解決方法は、**モジュール内でGitHub Providerのowner設定を明示的に行う**ことです。

```hcl
# github/modules/standard-repository/main.tf
terraform {
  required_providers {
    github = {
      source  = "integrations/github"
      version = "~> 6.0"
    }
  }
}

# モジュール内でプロバイダーにowner設定
provider "github" {
  owner = var.github_owner
}

resource "github_repository" "repo" {
  name         = var.repository_name
  description  = var.repository_description
  visibility   = var.visibility
  # ... その他の設定
}
```

```hcl
# github/modules/standard-repository/variables.tf
variable "github_owner" {
  description = "GitHub owner (user or organization)"
  type        = string
}
```

```hcl
# main.tf
provider "github" {
  owner = var.github_owner
}

module "samplerepo" {
  source = "./github/modules/standard-repository"
  
  github_owner           = var.github_owner
  repository_name        = "samplerepo"
  repository_description = "Sample repository"
  visibility            = "private"
}

import {
  to = module.samplerepo.github_repository.repo
  id = "samplerepo"
}
```

この設定により、importが正常に実行できるようになります。

## まとめ

Terraformのモジュール内でGitHubリソースをimportする際は、プロバイダー設定の継承に注意が必要です。

- **問題**: モジュール内のリソースがプロバイダーのowner設定を正しく参照できない
- **解決**: モジュール内でプロバイダーのowner設定を明示的に行う

この問題は GitHub Provider特有の制限によるものですが、モジュール内でのプロバイダー設定により解決可能です。モジュール化を進める際は、このような落とし穴があることを念頭に置いて設計することが重要です。

## 参考資料

- [GitHub Provider Issue #2262](https://github.com/integrations/terraform-provider-github/issues/2262)
- [Terraform Module Providers](https://developer.hashicorp.com/terraform/language/modules/develop/providers)

