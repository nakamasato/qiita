---
title: Dev Containerで安全にclaude codeを使う
tags: ClaudeCode devcontainer
author: nakamasato
slide: false
---
## まとめ

1. [Dev Container](https://code.visualstudio.com/docs/devcontainers/containers)の中でClaude Codeを起動することでプロジェクト内のファイルのみへのアクセスを許可することで意図しないファイルの変更・削除・作成などを避けることができます
1. claude codeの設定には以下の設定+`~/.claude`の永続化が必要です。これでコンテナ再作成してもログイン認証が行われなくなります
    ```json:.devcontainer/devcontainer.json
    {
        ...
    	"features": {
    		"ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {},
            ...
    	},
        "mounts": [
            "source=claude-code-config-${devcontainerId},target=/home/vscode/.claude,type=volume"
        ],
    	"containerEnv": {
    		"CLAUDE_CONFIG_DIR": "/home/vscode/.claude"
    	},
    	"containerUser": "vscode"
    }
    ```
    ※ vscodeは適宜コンテナイメージによって書き換えてください。
1. Anthropicの公式ページ[Development containers](https://docs.anthropic.com/en/docs/claude-code/devcontainer) でも紹介されているように `claude --dangerously-skip-permissions`をより安全に使う環境として薦められています。

## 導入手順

### 1. Dev Containers Extensionを追加

![Screenshot 2025-07-22 at 15.08.45.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/3adea44f-5f54-4d8a-bd1c-f2c354ba665d.png)


### 2. 設定ファイルの作成: プロジェクトルートに.devcontainer/devcontainer.jsonを作成

設定ファイルは `.devcontainer` 以下に配置します。 minimumではdevcontainer.jsonだけを配置すれば使うことができます。

```
tree .devcontainer/
.devcontainer/
├── Dockerfile <- optinal: Dockerfile使う場合
├── devcontainer.json
└── docker-compose.yml <- optional: docker-composeを使う場合

0 directories, 4 files
```

`.devcontainer/devcontainer.json` の設定全体像としては以下のようになります。(ref: [devcontainer.json](https://code.visualstudio.com/docs/devcontainers/tutorial#_devcontainerjson))

![Screenshot 2025-07-25 at 12.40.17.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/539227e5-08e6-4bbc-b395-cac923dc0105.png)


言語や開発する内容によって異なるので、今回はPythonのケースで紹介します。


#### 2.1. コンテナを準備する

開発コンテナの設定は、3つの方法があります。

1. 提供されているimageを直接使う (e.g. `mcr.microsoft.com/devcontainers/python:1-3.12-bullseye`) -> `.devcontainer/devcontainer.json`内の `"image": xxx` を書くだけで可
    ```json:.devcontainer/devcontainer.json
    {
        "name": "Python Devcontainer",
        "image": "mcr.microsoft.com/devcontainers/python:1-3.12-bullseye"
      ...
    }
    ```
1. 提供されているimageでは足りない場合`.devcontainer/Dockerfile`を用意する <- devcontainer用のcliやdirectoryなどの設定を自由にできるのでおすすめ
    ```json:.devcontainer/devcontainer.json
    {
        "name": "Python Devcontainer",
        "build": {
            "dockerfile": "Dockerfile",
            "context": "."
        }
        ...
    }
    ```
1. docker-composeを使う。この場合は、複数のコンテナを使える + devcontainer用のコンテナは上のOption1,2のどちらも使うことができます
    ```json:.devcontainer/devcontainer.json
    {
        "name": "Python Devcontainer",
        "dockerComposeFile": "docker-compose.yml",
        ...
    }
    ```

:::note info

初めて導入する場合は以下のようなイメージでシンプルなものから始めるのがおすすめです。

1. まずは提供されているimageを直接使ってみる (e.g. `mcr.microsoft.com/devcontainers/python:1-3.12-bullseye`)
1. 必要なfeaturesを探して追加していく (gh, claude, uv, などのcliツールたち)
1. 提供されているimageでは足りなくなったら Dockerfileを作成してbuildするようにする
1. DBなど他のコンテナにも接続する必要があれば、docker-compose, docker-in-docker, docker-outside-of-dockerなどを考慮していく
:::

参考までに、Dockerfileは以下のようになります。もちろんこちらもプロジェクトによるので、必要なコマンドなど適宜調整すればよさそうです。このDockerfile自体もClaude Codeに作成してもらいました。

<details><summary>Dockerfile</summary>

```Dockerfile
FROM mcr.microsoft.com/devcontainers/python:3.13

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive

# Install system packages
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    vim \
    nano \
    htop \
    tree \
    jq \
    unzip \
    zip \
    build-essential \
    libssl-dev \
    libffi-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libncurses5-dev \
    libncursesw5-dev \
    xz-utils \
    tk-dev \
    libxml2-dev \
    libxmlsec1-dev \
    libffi-dev \
    liblzma-dev \
    # PostgreSQL client for Task7
    postgresql-client \
    # For network checks
    netcat-traditional \
    # For build calculations
    bc \
    # For Docker in Docker support
    docker.io \
    # For container management
    docker-compose \
    # make
    make \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install uv (Python package manager)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Install pre-commit
RUN pip install pre-commit==4.2.0

# Create workspace directory
WORKDIR /workspace

# Set the default shell to bash
SHELL ["/bin/bash", "-c"]

# Configure git to be safe for the workspace
RUN git config --global --add safe.directory /workspace

# Set up user permissions for vscode user
USER vscode

# Install uv for vscode user
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/home/vscode/.local/bin:$PATH"

# Ensure the workspace is writable by vscode user
RUN sudo chown -R vscode:vscode /workspace

# Set working directory
WORKDIR /workspace
```


若干不要な設定も入ってるかもしれませんが、適宜調整ということで。

</details>

#### 2.2. `features`

devcontainer features を使うと imageの変更なしで cliなどのツールを追加することができます。

```json:.devcontainer/devcontainer.json
    ...
    "features": { // gh, claude code, uvなどのツールを追加できる
        "ghcr.io/devcontainers/features/github-cli:1": {
            "version": "latest"
        },
        "ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {},
        "ghcr.io/jsburckhardt/devcontainer-features/uv:1": {}
    }
```

#### 2.3. `mounts`

コンテナの選択のときに、imageまたはDockerfileで設定している場合には、Docker volumeやホストマシンのファイルやディレクトリのマウント定義を追加することがあります。

例えば、 `~/.claude` をコンテナにbindしたり、 zsh historyのディレクトリをマウントする (下の例ではdocker volume にこれらの情報を保存して、devcontainerごとに独立したdocker volumeに保存することもできあmす。)

```json:.devcontainer/devcontainer.json
{
    "mounts": [ // 必要に応じてホストマシンのディレクトリをmountする
        "source=${localEnv:HOME}/.claude,target=/home/vscode/.claude,type=bind",
        "source=${localEnv:HOME}/.zsh_history,target=/home/vscode/.zsh_history,type=bind",
        "source=${localEnv:HOME}/.zshrc,target=/home/vscode/.zshrc,type=bind"
    ],
}
```

#### 2.4. その他

その他にも `initializeCommand`, `reomoteUser` など様々な設定があるので、詳細は[devcontainer.json](https://code.visualstudio.com/docs/devcontainers/tutorial#_devcontainerjson
)を見ながら必要に応じて設定していくのがいいと思います。

```json
    "initializeCommand": ".devcontainer/init.sh",
    "remoteUser": "vscode",
    "containerUser": "vscode"
```


### 2. VS Codeで開く: VS Codeで「Reopen in Container」を選択

mac の場合は `command + p` でパレットを開いて `> dev container` とかくと選択肢がでてくるので、`Reopen in Container` で開きます。

![Screenshot 2025-07-22 at 18.04.08.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/be0e0301-2bf9-4d5a-9fc2-69b0a5183521.png)

### 3. Claude Codeの確認: コンテナ内でClaude Codeが使用可能か確認

コンテナの中でいつもどおりclaude を叩くとcontainerの中でclaudeを使えるようになります。

```
claude
```

![Screenshot 2025-07-25 at 12.41.28.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/5b82c428-2b47-43ad-8180-53a0070ecc20.png)


:::note info
これによって関係ないホストマシンのファイルを勝手に触られたりすることを防ぐことができます。
:::


## 初めて使おうとしたときに引っかかること

### devcontainerで立ち上げると ~/.claudeの設定読み込めない

`~/.claude`以下に様々なユーザ設定が読み込めないと困ります。

#### Option1: 雑にホストマシンの~/.claudeをマウントする

```diff:.devcontainer/devcontainer.json
  "mounts": [
+    "source=${localEnv:HOME}/.claude,target=/home/vscode/.claude,type=bind"
  ],
```

#### Option2: Docker Volumeにマウントする

`Dockerfile`を定義する場合は、directoryを作成して権限を付与して、docker volumeにマウントします。

```Dockerfile
# Create claude config directories and set permissions
RUN mkdir -p /home/$USERNAME/.claude && \
  chown -R $USERNAME /home/$USERNAME/.claude
```

Option1: Dockerfile or imageの場合

```diff:.devcontainer/devcontainer.json
    ...
	"mounts": [
        ...
+		"source=claude-code-config-${devcontainerId},target=/home/vscode/.claude,type=volume"
	],
    ...
```

Option2: docker-composeの場合

```diff:docker-compose.yml
 services:
   devcontainer:
     build: .
     volumes:
       - ../..:/workspaces:cached
+      - claude-code-config:/home/vscode/.claude
     command: sleep infinity
...

 volumes:
+  claude-code-config:
```

### コンテナ再作成時に毎回claude認証をさせられる

以下を設定しておくことで、コンテナを再作成しても、`~/.claude`を永続化しておけば、毎回のログイン認証が不要になります。

```diff:.devcontainer/devcontainer.json
+	"containerEnv": {
+		"CLAUDE_CONFIG_DIR": "/home/vscode/.claude"
+	},
```

:::note warn
最近 Long-lived authentication tokenがサポートされたので、環境変数にいれたらいけるかなと思って試しましたがだめでした。
:::

### rootユーザだと`claude --dangerously-skip-permissions`が使えない

```
--dangerously-skip-permissions cannot be used with root/sudo privileges for security reasons
```

せっかくdevcontainerにしたのにYOLOできないと困りますね。

userを指定しましょう。(ref: https://code.visualstudio.com/remote/advancedcontainers/add-nonroot-user)

```json
  "removeUser": "vscode"
```

コンテナ内で`whoami`を打つとvscodeになっています。

```
whoami
vscode
```

`claude --dangerously-skip-permissions`が使えるようになります!

![Screenshot 2025-07-09 at 22.16.19.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/de6e5f15-6edb-4c20-b94e-947fb3c83dcb.png)

`~/`はもちろんコンテナ内なので問題ありません。

### VSCodeのExtensionをDevcontainerにいれる

customizations.vscode.extensions に追加することでdevcontainerにextensionを追加できる。

```diff
{
    ...
+	"customizations": {
+		"vscode": {
+			"extensions": [
+				"shd101wyy.markdown-preview-enhanced"
+			]
+		}
+	},
    ...
}
```

### 使いたいcliコマンドがない

最初はDockerfileを使わずに直接 `"image": "mcr.microsoft.com/devcontainers/python:3.13"`を使おうとしていました。しかし必要なcommandが入っていないケースがあります。

```
gh: command not found
```

[Devcontainer Features](https://code.visualstudio.com/docs/devcontainers/containers#_dev-container-features)を使う

```json
"features": {
    "ghcr.io/devcontainers/features/github-cli:1": {
        "version": "latest"
    }
}
```

結局他にも必要なコマンドをContainerに入れておく必要があるので、 Dockerfileを作ることにしました。

Claude Codeに作成してもらいました。

<details><summary>参考までDockerfile</summary>

```Dockerfile
FROM mcr.microsoft.com/devcontainers/python:3.13

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive

# Install system packages
RUN apt-get update && apt-get install -y \
    git \
    curl \
    wget \
    vim \
    nano \
    htop \
    tree \
    jq \
    unzip \
    zip \
    build-essential \
    libssl-dev \
    libffi-dev \
    libbz2-dev \
    libreadline-dev \
    libsqlite3-dev \
    libncurses5-dev \
    libncursesw5-dev \
    xz-utils \
    tk-dev \
    libxml2-dev \
    libxmlsec1-dev \
    libffi-dev \
    liblzma-dev \
    # PostgreSQL client for Task7
    postgresql-client \
    # For network checks
    netcat-traditional \
    # For build calculations
    bc \
    # For Docker in Docker support
    docker.io \
    # For container management
    docker-compose \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install uv (Python package manager)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Install GitHub CLI
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install pre-commit
RUN pip install pre-commit==4.2.0

# Install make (if not already present)
RUN apt-get update && apt-get install -y make && apt-get clean && rm -rf /var/lib/apt/lists/*

# Create workspace directory
WORKDIR /workspace

# Set the default shell to bash
SHELL ["/bin/bash", "-c"]

# Configure git to be safe for the workspace
RUN git config --global --add safe.directory /workspace

# Set up user permissions for vscode user
USER vscode

# Install uv for vscode user
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/home/vscode/.local/bin:$PATH"

# Ensure the workspace is writable by vscode user
RUN sudo chown -R vscode:vscode /workspace

# Set working directory
WORKDIR /workspace
```

</details>

### gitの認証をLocalから共有して使う

[Sharing Git credentials with your container](https://code.visualstudio.com/remote/advancedcontainers/sharing-git-credentials) を使うとホストの認証をコンテナ内で使うことができます。

これがうまく動いていると devcontainer内の `~/.gitconfig`の `[credentials]`が以下のようにgit credential helperが指定されている事がわかります。

```
[credential]
        helper = "!f() { /home/vscode/.vscode-server/bin/xxxxx/node /tmp/vscode-remote-containers-xxxxx.js git-credential-helper $*; }; f"
```

この時点で`git push` `git pull`など問題なく行うことができます。

### gh認証の簡易化

コンテナに入ってgitは使えるのですが、gh認証は毎回コンテナで`gh auth login`をする必要があります。

claude codeではgh commandを使って結構作業してもらうことが多いので、自動的に設定したい気持ちになります。

Optionalですが、コンテナ作成時にホストマシンの`gh auth token` を設定するやり方にして一手間省くことができました。


普段ローカルでは、あまり意識してませんが、ほとんどのケースで `gh auth login` で gh CLIの認証をしたあとに、 gh の credential helperを使ってgitを使っているのではないでしょうか。 
```
gh auth setup-git
```

を実行することで gh credential helperをgitのcredential helperにすることができます ([gh auth setup-git](https://cli.github.com/manual/gh_auth_setup-git))

もうすこしgh authの話をすると、MacOSでは、`gh auth login`で、keychainにcredentialsが保存されるため、devcontainersのコンテナ内でLocalの`gh auth login`で認証したcredentialsを使うのは難しいです。

> Once you've authenticated successfully, your credentials are stored in the macOS keychain and will be used every time you clone an HTTPS URL. 

何もしないと、以下のようなauthを要求するメッセージが出てしまいます。

```
HTTP 401: This endpoint requires you to be authenticated. (https://api.github.com/graphql)
Try authenticating with:  gh auth login
```

解決策としては2つありそうです。

1. GH_TOKENをdevcontainerにセットしてコンテナを起動する
1. gh auth loginでcredentialsを--unsecure-storageに保存してマウントする

後者はせっかくgh authがkeychainに保存してSecureにCredential情報を管理しているのに反するためWorkaroundとしては、前者を使おうと思います。

https://zenn.dev/okhiroyuki/scraps/7a6354720c1bc0

こちらの記事で紹介されているやりかたでやります。

```sh:.devcontainer/init.sh
#!/bin/bash

# check gh token
if which gh &>/dev/null; then
    gh auth token | xargs -I {} echo "GH_TOKEN="{} > .devcontainer/.env.devcontainer
fi
```

Dockerfileやimageを使ってる場合は以下のように設定します。

```diff:.devcontainer/devcontainer.json
{
    ...
+    "initializeCommand": ".devcontainer/init.sh",
+    "runArgs": [
+        "--env-file",
+        ".devcontainer/.env.devcontainer"
+    ],
    ...
}
```

docker-composeを使ってる場合には、initializeCommandとenv_fileの設定を書きます。

```diff:.devcontainer/devcontainer.json
{
    ...
+    "initializeCommand": ".devcontainer/init.sh",
    ...
}
```

```diff:.devcontainer/docker-compose.yaml
 services:
   devcontainer:
     ...
     env_file:
       ...
+      - .env.devcontainer
```


`.gitignore`に `.env.devcontainer`を追加しておきましょう。

これで、devcontainerに入った段階で `GH_TOKEN` で認証されている状態になります。

```
gh auth status
github.com
  ✓ Logged in to github.com account nakamasato (GH_TOKEN)
  - Active account: true
  - Git operations protocol: https
  - Token: gho_************************************
  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'
```

### bash historyを保存する

[Persist bash history
](https://code.visualstudio.com/remote/advancedcontainers/persist-bash-history)

Docker volumeに保存できるようにします。カスタムイメージを使う必要があります。Dockerfileに以下を追加します。

```Dockerfile
ARG USERNAME=vscode

# Used to persist bash history as per https://code.visualstudio.com/remote/advancedcontainers/persist-bash-history
RUN SNIPPET="export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
    && mkdir /commandhistory \
    && touch /commandhistory/.bash_history \
    && chown -R $USERNAME /commandhistory \
    && echo "$SNIPPET" >> "/home/$USERNAME/.bashrc"
```

Volume を `/commandhistory` にマウント:

Option1: Dockerfile or imageを使ってる場合は、devcontainer.json内で定義します。

```diff:devcontainer.json
{
    ...
	"mounts": [
        ...
+		"source=commandhistory-${devcontainerId},target=/commandhistory,type=volume"
	],
    ...
}
```

Option2: docker-composeを使ってる場合は、volumeとmountを追加します。

```diff:.devcontainer/docker-compose.yaml
 services:
   devcontainer:
     build: .
     volumes:
       - ../..:/workspaces:cached
+      - commandhistory:/commandhistory
     command: sleep infinity
...

 volumes:
+  commandhistory:
```

### ~/.cache のマウント

pre-commitなどは~/.cacheにキャッシュを置くので同様にVolumeを用意する

```Dockerfile
# Create cache directory and set permissions
RUN mkdir -p /home/$USERNAME/.cache && \
  chown -R $USERNAME /home/$USERNAME/.cache
```

```diff:docker-compose.yml
  services:
    devcontainer:
      build: .
      volumes:
+       - cache:/home/vscode/.cache

  volumes:
...
+   cache:
```

### Dockerをdevcontainerの中から使う

DBをDockerで立ち上げたりしているケースだとdevcontainerの中からDockerコンテナへアクセスが必要になるので、いくつかの方法があります。

1. Docker-in-Docker: Docker デーモンをdevcontainer内で立ち上げて使う
1. Docker-outside-of-Docker: ホストのDockerデーモンを共有する (Example: [docker-outside-of-docker-compose](https://github.com/devcontainers/templates/tree/main/src/docker-outside-of-docker-compose)
1. docker-composeを使う (https://code.visualstudio.com/docs/devcontainers/create-dev-container#_use-docker-compose)
    1. Example: [Python3 + PostgreSQL](https://github.com/devcontainers/templates/tree/main/src/postgres)

docker compose を使うのがなんだかんだ一番楽かなと重い下の例でもdocker composeを使っています。

### pre-commitを自動でinstallしたい

`.devcontainer/post-start.sh` を用意してその中に `pre-commit install` など書いて置くことができます。

```sh:.devcontainer/post-start.sh
#!/bin/bash

pre-commit install
```

```json:.devcontainer/devcontainer.json
{
    ...
    "postStartCommand": ".devcontainer/post-start.sh",
}
```

### Devcontainerから抜けたい

`Reopen Folder Locally` でDevcontainerから抜けられます。

![Screenshot 2025-07-22 at 18.03.52.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/7b876fb0-7141-41b2-a727-71c47dcc9256.png)


## Appendix: https://github.com/nakamasato/flask-sample にdevcontainerを導入するステップ紹介

### Step1: 最低限のPython imageでDevcontainer起動

```json:.devcontainer/devcontainer.json
{
	"name": "Python 3",
	"image": "mcr.microsoft.com/devcontainers/python:1-3.12-bullseye",
	"features": {
		"ghcr.io/devcontainers/features/github-cli:1": {},
		"ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {},
		"ghcr.io/devcontainers-extra/features/poetry:2": {},
        "ghcr.io/devcontainers-extra/features/pre-commit:2": {}
	},
	"remoteUser": "vscode",
	"containerUser": "vscode"
}
```

この時点で、
- source codeへのアクセス、 gitへのアクセスができる
- gh command, claude code, poetry, pre-commit が使えるようになる

### Step2: Docker ComposeにしてDBも使えるようにする

このレポではflask appがmysqlへ接続する構成なので、devcontainerでもmysql containerが必要

```yaml:.devcontainer/docker-compose.yml
version: '3.8'
services:
  devcontainer:
    image: "mcr.microsoft.com/devcontainers/python:1-3.12-bullseye"
    volumes:
      - ../..:/workspaces:cached
    env_file:
      - ../docker/env_file/env.app
      - ../docker/env_file/env.mysql
    command: sleep infinity
    ports:
      - 8000:5000

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/mysql
      - ../docker/mysql/schema/user.sql:/docker-entrypoint-initdb.d/01_schema_user.sql
      - ../docker/mysql/data/user.sql:/docker-entrypoint-initdb.d/11_data_user.sql
      - ../docker/mysql/conf.d/:/etc/mysql/conf.d/
    env_file:
      - ../docker/env_file/env.mysql
    ports:
      - 3306:3306
    healthcheck:
      test: ["CMD", "mysqladmin", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  db_data:
```

```json:.devcontainer/devcontainer.json
{
	"name": "Python 3",
	"dockerComposeFile": "docker-compose.yml",
	"service": "devcontainer",
    "workspaceFolder": "/workspaces/flask-sample", 
	"features": {
		"ghcr.io/devcontainers/features/github-cli:1": {},
		"ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {},
		"ghcr.io/devcontainers-extra/features/poetry:2": {},
        "ghcr.io/devcontainers-extra/features/pre-commit:2": {}
	},
	"remoteUser": "vscode",
	"containerUser": "vscode"
}
```

これでflaskが立ち上がるようになる `FLASK_APP=sample FLASK_ENV=development poetry run flask run --host=0.0.0.0`

![Screenshot 2025-07-22 at 17.19.56.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/a8030b99-c858-42df-9f13-04db137f7cec.png)

`8000:5000`をportsに設定しているので、hostのlocalhost:8000でdevcontainerの5000 portにアクセスできる。

```
curl localhost:8000/health
{"status":"healthy"}
```

### Step3: 最終盤

- `Dockerfile` 作成
    - `.zsh_history`, `~/.claude` のマウント
    - `tig`コマンドインストール
- pre-commit installをcontainer開始時に実行
- gh auth tokenをGH_TOKENに設定
- Shellをzshにする

```
tree .devcontainer/
.devcontainer/
├── Dockerfile
├── devcontainer.json
└── docker-compose.yml

0 directories, 3 files
```

```Dockerfile:.devcontainer/Dockerfile
FROM mcr.microsoft.com/devcontainers/python:1-3.12-bullseye

ARG USERNAME=vscode

# Install tig
RUN apt-get update && apt-get install -y tig && apt-get clean

# Used to persist shell history
RUN mkdir /commandhistory \
    && touch /commandhistory/.bash_history \
    && touch /commandhistory/.zsh_history \
    && chown -R $USERNAME /commandhistory \
    && echo 'export PROMPT_COMMAND="history -a" && export HISTFILE=/commandhistory/.bash_history' >> "/home/$USERNAME/.bashrc" \
    && echo 'export HISTFILE=/commandhistory/.zsh_history' >> "/home/$USERNAME/.zshrc"

# Create claude config directories and set permissions
RUN mkdir -p /home/$USERNAME/.claude && \
  chown -R $USERNAME /home/$USERNAME/.claude

```

```json:.devcontainer/devcontainer.json
{
	"name": "Python 3",
	"dockerComposeFile": "docker-compose.yml",
	"service": "devcontainer",
	"workspaceFolder": "/workspaces/flask-sample",
	"features": {
		"ghcr.io/devcontainers/features/github-cli:1": {},
		"ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {},
		"ghcr.io/devcontainers-extra/features/poetry:2": {},
		"ghcr.io/devcontainers-extra/features/pre-commit:2": {},
		"ghcr.io/devcontainers/features/common-utils:2": {
			"installZsh": true,
			"installOhMyZsh": true,
			"configureZshAsDefaultShell": true
		}
	},
	"customizations": {
		"vscode": {
			"extensions": [
				"shd101wyy.markdown-preview-enhanced"
			]
		}
	},
	"containerEnv": {
		"CLAUDE_CONFIG_DIR": "/home/vscode/.claude"
	},
	"postStartCommand": "pre-commit install",
	"initializeCommand": "echo \"GH_TOKEN=$(gh auth token)\" > .devcontainer/.env.devcontainer",
	"containerUser": "vscode"
}
```

```yaml:.devcontainer/docker-compose.yml
services:
  devcontainer:
    build: .
    volumes:
      - ../..:/workspaces:cached
      - commandhistory:/commandhistory
      - claude-code-config:/home/vscode/.claude
    env_file:
      - ../docker/env_file/env.app
      - ../docker/env_file/env.mysql
      - .env.devcontainer
    command: sleep infinity
    ports:
      - 8000:5000

  mysql:
    image: mysql:8.0
    restart: unless-stopped
    volumes:
      - db_data:/var/lib/mysql
      - ../docker/mysql/schema/user.sql:/docker-entrypoint-initdb.d/01_schema_user.sql
      - ../docker/mysql/data/user.sql:/docker-entrypoint-initdb.d/11_data_user.sql
      - ../docker/mysql/conf.d/:/etc/mysql/conf.d/
    env_file:
      - ../docker/env_file/env.mysql
    ports:
      - 3306:3306
    healthcheck:
      test: ["CMD", "mysqladmin", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  db_data:
  commandhistory:
  claude-code-config:
```

## TODO

- Claude Codeの[Development containers](https://docs.anthropic.com/en/docs/claude-code/devcontainer)の中の`Custom firewall restricting network access to only necessary services` はまだ試せていない。 (https://github.com/anthropics/claude-code/tree/main/.devcontainer)
- [multiple containers](https://code.visualstudio.com/remote/advancedcontainers/connect-multiple-containers): モノレポのケースで使えそう


## 参考

- VSCode Devcontainer:
    - [Developing inside a Container
](https://code.visualstudio.com/docs/devcontainers/containers)
    - [Advanced container](https://code.visualstudio.com/remote/advancedcontainers/overview)
- claude code
    - https://docs.anthropic.com/en/docs/claude-code/devcontainer
    - https://github.com/anthropics/claude-code/tree/main/.devcontainer
- devcontainer feature anthropic: https://github.com/anthropics/devcontainer-features
- devcontainer cli: https://github.com/devcontainers/cli
- gh
    - [devcontainerでgh cliをスムーズに利用する](https://zenn.dev/okhiroyuki/scraps/7a6354720c1bc0)
    - [Dev Containerで最強のPython開発環境を作る 〜その1・Pythonスクリプトを動かす〜
](https://qiita.com/im-dev/items/a2eb4ebba6b6df1e0521)
- [Claude CodeをApple Containerの中で動かす](https://zenn.dev/schroneko/articles/claude-code-on-apple-container)
- devcontainer examples
    - https://github.com/sooperset/mcp-atlassian/blob/main/.devcontainer/devcontainer.json

