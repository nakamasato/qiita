---
title: atlas + sqlalchemy
tags: atlas sqlalchemy DB
author: nakamasato
slide: false
---
## 準備

```bash
poetry add atlas-provider-sqlalchemy # or pip install atlas-provider-sqlalchemy
```

poetry でinstallした場合は

```
PATH=$(poetry env info --path)/bin:$PATH
```

で`atlas-provider-sqlalchemy` が使えるようにしておく


## sqlalchemy管理からatlasへ

1. `db/migrations` dirを作っておく

    ```
    mkdir -p db/migrations
    ```

1. 以下のコマンドで現状のsqlalchemyでの定義をSQLに落とせる

    ```
    poetry run atlas-provider-sqlalchemy --path ./db --dialect postgresql >> db/migrations/$(date -u '+%Y%m%d%H%M%S')_init.sql
    ```

    `db/migrations/20240907044849_init.sql`というファイルが作成される

1. applyで確認
    ```
    atlas migrate apply --env sqlalchemy
    ```

    2回目は実行しても変更なし

    ```
    atlas migrate apply --env sqlalchemy
    No migration files to execute
    ```
1. 

## Error `connected database is not clean`

```
Error: sql/migrate: taking database snapshot: sql/migrate: connected database is not clean: found table "xxx" in connected schema
```

## Ref

1. https://atlasgo.io/guides/orms/sqlalchemy

