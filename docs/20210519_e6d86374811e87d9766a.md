---
title: Kubernetes HPAã® Alpha Feature HPAScaleToZeroã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§è©¦ã™
tags: kubernetes HorizontalPodAutoscaler HPA prometheus RabbitMQ
author: nakamasato
slide: false
---
# èƒŒæ™¯

HPAã§ã¯ã‚¼ãƒ­ã«ScaleInå‡ºæ¥ãªã„ã€‚

```bash
kubectl explain HorizontalPodAutoscaler.spec.minReplicas
KIND:     HorizontalPodAutoscaler
VERSION:  autoscaling/v1

FIELD:    minReplicas <integer>

DESCRIPTION:
     minReplicas is the lower limit for the number of replicas to which the
     autoscaler can scale down. It defaults to 1 pod. minReplicas is allowed to
     be 0 if the alpha feature gate HPAScaleToZero is enabled and at least one
     Object or External metric is configured. Scaling is active as long as at
     least one metric value is available.
```

> minReplicas is allowed to
be 0 if the alpha feature gate HPAScaleToZero is enabled and at least one
Object or External metric is configured.

- alpha feature gateã‚’ enableã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- Object or External metricå°‘ãªãã¨ã‚‚1ã¤ã¯å¿…è¦

[Kubernetesã®HPA with custom metricsã‚’RabbitMQã¨Prometheusã§è©¦ã™](https://qiita.com/gymnstcs/items/ae375899d254b7b36c80) ã§ç´¹ä»‹ã—ãŸHPA with custom metricsã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã ã¨ã€Queueã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚¼ãƒ­ã®ã¨ãã¯å®Œå…¨ã«ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³ã—ãŸã„å ´åˆã‚‚ã‚ã‚‹ã€‚ä»Šå›ã¯ã€HPAã§0ã«ã¾ã§ã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³ã‚’è©¦ã™ã€‚

# Feature Gateã¨ã¯

[feature-gates](https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/): å„Kubernetes Featureã®Stageã¨Defaultã§Enableã•ã‚Œã¦ã„ã‚‹ã‹ã€ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰(ã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ã§)ä½¿ç”¨å¯èƒ½ã‹ãŒãƒ†ãƒ¼ãƒ–ãƒ«ã«ãªã£ã¦ã„ã‚‹ã€‚

Enableã™ã‚‹ã«ã¯ã€ `-feature-gates="...,DynamicKubeletConfig=true"` èµ·å‹•æ™‚ã®ã‚³ãƒãƒ³ãƒ‰ã«Enableã™ã‚‹Featureãƒšã‚¢ (Featureåã¨true/false) ã‚’ãƒªã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹

ä»Šå›ä½¿ã„ãŸã„`HPAScaleToZero`ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ `HPAScaleToZero	false	Alpha	1.16` ã¨ãªã£ã¦ãŠã‚Šã€ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯æ˜ç¤ºçš„ã«enableã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚


# ãƒ­ãƒ¼ã‚«ãƒ«ã§`HPAScaleToZero` ã‚’Enableã«ã—ãŸKubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆ

ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«æŒ™å‹•ã®ç¢ºèªã‚’ã—ãŸã„ã®ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§æŒ‡å®šãŒç°¡å˜ã«ã§ããã†ãª [kind](https://kind.sigs.k8s.io/) ã‚’ä½¿ç”¨

## Prerequisite

- go (1.11+)
- Docker

## kindã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Macã®å ´åˆã¯ã€brewã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ (è©³ç´°ã¯ [https://kind.sigs.k8s.io/docs/user/quick-start/#installation](https://kind.sigs.k8s.io/docs/user/quick-start/#installation))

```yaml
brew install kind
```

## kindã®ã‚¯ãƒ©ã‚¹ã‚¿ç”¨ã®Yamlã‚’æº–å‚™

```yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
featureGates:
  # any feature gate can be enabled here with "Name": true
  # or disabled here with "Name": false
  # not all feature gates are tested, however
  "HPAScaleToZero": true
```

## kindã§Kubernertes Clusterã‚’ä½œæˆ

```yaml
kind create cluster --config cluster-with-alpha-feature.yaml
```

```yaml
kind create cluster --config cluster-with-alpha-feature.yaml
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.20.2) ğŸ–¼ 
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Thanks for using kind! ğŸ˜Š
```

# HPAã®ãŸã‚ã®æº–å‚™

[å‰å›](https://qiita.com/gymnstcs/items/ae375899d254b7b36c80)ã¨åŒã˜ã‚‚ã®ã‚’Deploy

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/7059/44ec751e-e6ca-9679-f52b-6dcd5263a4e7.png)

ï¼ˆä»Šå›ã¯Grafanaãªã©ã¯çœç•¥ï¼‰

1. Code ã‚’clone

    ```bash
    git clone https://github.com/nakamasato/kubernetes-training && cd kubernetes-training/autoscaler/hpa/custom-metrics
    ```

2. Prometheus with operator

    ```bash
    kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/bundle.yaml
    kubectl create ns monitoring
    kubectl apply -k ../../../prometheus-operator -n monitoring
    ```

3. RabbitMQ with operator

    ```bash
    kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
    kubectl apply -f rabbitmq/rabbitmq-cluster.yaml
    kubectl apply -f rabbitmq/pod-monitor-rabbitmq.yaml
    ```

4. RabbitMQConsumer & Producer

    ```bash
    kubectl apply -f rabbitmq-producer-cronjob.yaml
    kubectl apply -f rabbitmq-consumer-deployment.yaml
    ```

5. Prometheus Adapter ã‚’Deploy([https://github.com/stefanprodan/k8s-prom-hpa/](https://github.com/stefanprodan/k8s-prom-hpa/))

    ```bash
    git clone git@github.com:stefanprodan/k8s-prom-hpa.git && cd k8s-prom-hpa
    touch metrics-ca.key metrics-ca.crt metrics-ca-config.json
    make certs
    kubectl create -f ./custom-metrics-api
    ```

6. `rabbitmq_queue_messages_ready` ãŒ `[custom.metrics.k8s.io](http://custom.metrics.k8s.io)` ã‹ã‚‰å–å¾—ã§ãã‚‹ã®ã‚’ç¢ºèª

    ```bash
    kubectl get --raw "/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/rabbitmq_queue_messages_ready"| jq .
    {
      "kind": "MetricValueList",
      "apiVersion": "custom.metrics.k8s.io/v1beta1",
      "metadata": {
        "selfLink": "/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/%2A/rabbitmq_queue_messages_ready"
      },
      "items": [
        {
          "describedObject": {
            "kind": "Pod",
            "namespace": "default",
            "name": "rabbitmq-server-0",
            "apiVersion": "/v1"
          },
          "metricName": "rabbitmq_queue_messages_ready",
          "timestamp": "2021-05-19T01:55:02Z",
          "value": "0"
        }
      ]
    }
    ```

# HPAã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ (`minReplicas: 0`)

```yaml:rabbitmq-consumer-hpa-with-min-zero.yaml
apiVersion: autoscaling/v2beta2
kind: HorizontalPodAutoscaler
metadata:
  name: rabbitmq-consumer
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: rabbitmq-consumer
  minReplicas: 0
  maxReplicas: 20
  metrics:
    - type: Object
      object:
        metric:
          name: rabbitmq_queue_messages_ready
        describedObject:
          kind: Pod
          name: rabbitmq-server-0
          apiVersion: v1
        target:
          type: Value
          averageValue: 1
```

```bash
kubectl apply -f rabbitmq-consumer-hpa-with-min-zero.yaml
```

ç¢ºèª `New size: 0` ã¨ãªã£ã¦ã‚‹ã“ã¨ã‚’ç¢ºèª!

```bash
Events:
  Type    Reason             Age                  From                       Message
  ----    ------             ----                 ----                       -------
  Normal  SuccessfulRescale  35m                  horizontal-pod-autoscaler  New size: 7; reason: All metrics below target
  Normal  SuccessfulRescale  30m (x2 over 40m)    horizontal-pod-autoscaler  New size: 16; reason: All metrics below target
  Normal  SuccessfulRescale  30m (x2 over 39m)    horizontal-pod-autoscaler  New size: 18; reason: All metrics below target
  Normal  SuccessfulRescale  25m (x2 over 35m)    horizontal-pod-autoscaler  New size: 14; reason: All metrics below target
  Normal  SuccessfulRescale  25m                  horizontal-pod-autoscaler  New size: 4; reason: All metrics below target
  Normal  SuccessfulRescale  20m                  horizontal-pod-autoscaler  New size: 1; reason: All metrics below target
  Normal  SuccessfulRescale  10m (x4 over 40m)    horizontal-pod-autoscaler  New size: 4; reason: external metric rabbitmq_queue_messages_ready(nil) above target
  Normal  SuccessfulRescale  5m13s (x4 over 35m)  horizontal-pod-autoscaler  New size: 2; reason: All metrics below target
  Normal  SuccessfulRescale  4m58s                horizontal-pod-autoscaler  New size: 0; reason: All metrics below target
  Normal  SuccessfulRescale  37s (x9 over 20m)    horizontal-pod-autoscaler  (combined from similar events): New size: 4; reason: external metric rabbitmq_queue_messages_ready(nil) above target
  Normal  SuccessfulRescale  22s (x4 over 40m)    horizontal-pod-autoscaler  New size: 8; reason: external metric rabbitmq_queue_messages_ready(nil) above target
  Normal  SuccessfulRescale  6s                   horizontal-pod-autoscaler  New size: 16; reason: external metric rabbitmq_queue_messages_ready(nil) above targe
```

# ç‰‡ä»˜ã‘

1. Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç‰‡ä»˜ã‘

    ```
    kubectl delete -f rabbitmq-consumer-hpa-with-min-zero.yaml
    kubectl delete -f rabbitmq-producer-cronjob.yaml
    kubectl delete -f rabbitmq-consumer-deployment.yaml
    kubectl delete -f https://k8s.io/examples/application/php-apache.yaml
    kubectl delete -f rabbitmq/rabbitmq-cluster.yaml
    kubectl delete -k ../../../prometheus-operator -n monitoring
    kubectl delete -f ./k8s-prom-hpa/custom-metrics-api                                                           
    kubectl delete -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
    kubectl delete -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/master/bundle.yaml
    ```

1. kindã‚¯ãƒ©ã‚¹ã‚¿ã®å‰Šé™¤

    ```
    kind delete cluster --name kind
    ```

# ã¾ã¨ã‚

Alpha Featureã® `HPAScaleToZero` ã‚’ãƒ­ãƒ¼ã‚«ãƒ«Kubernetesã‚¯ãƒ©ã‚¹ã‚¿kindã§Enableã—ã¦ã€Custom Metricsã«ã‚ˆã‚‹HPAã§ `minReplicas: 0` ã®å‹•ä½œã‚’ç¢ºèªã§ããŸã€‚

# å‚è€ƒãƒªãƒ³ã‚¯

- https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/
- https://github.com/nakamasato/kubernetes-training/tree/master/autoscaler/hpa/custom-metrics
- https://qiita.com/gymnstcs/items/ae375899d254b7b36c80
- https://kind.sigs.k8s.io/docs/user/quick-start/#installation

